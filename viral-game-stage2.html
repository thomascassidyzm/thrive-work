<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THRIVE - Deep Dive: Your Specific Patterns</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f3460 0%, #16213e 50%, #1a1a2e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffff00;
            border-radius: 50%;
            opacity: 0.6;
            animation: float 6s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-10px) rotate(360deg);
                opacity: 0;
            }
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            opacity: 0;
            animation: fadeIn 0.2s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .game-card.fade-out {
            animation: fadeOut 0.15s ease forwards;
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
        }

        .logo {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ffff00, #ffff66, #ffff00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .subtitle {
            font-size: 1.6rem;
            margin-bottom: 2rem;
            color: #e0e0e0;
            font-weight: 500;
        }

        .stage-indicator {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid rgba(255, 255, 0, 0.4);
            border-radius: 10px;
            padding: 0.8rem 1.5rem;
            display: inline-block;
            margin-bottom: 2rem;
            color: #ffff00;
            font-weight: 600;
        }

        .description {
            font-size: 1.1rem;
            line-height: 1.7;
            margin-bottom: 1.5rem;
            color: #c0c0c0;
            text-align: left;
        }

        .previous-result {
            background: rgba(255, 255, 0, 0.1);
            border: 2px solid rgba(255, 255, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem 0;
            text-align: left;
        }

        .previous-result-title {
            color: #ffff00;
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .previous-result-text {
            color: #e0e0e0;
            font-size: 1rem;
            line-height: 1.6;
        }

        .highlight {
            color: #ffff00;
            font-weight: 600;
        }

        .start-button {
            background: linear-gradient(45deg, #ffff00, #ffff66);
            color: #000;
            border: none;
            padding: 1.2rem 2.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.4);
            margin-top: 1rem;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.6);
        }

        /* Question Screen */
        .question-screen {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffff00, #ffff66);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }

        .question-number {
            color: #ffff00;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .question-text {
            font-size: 1.4rem;
            margin-bottom: 2.5rem;
            line-height: 1.6;
            color: #ffffff;
            font-weight: 400;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .option {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 2px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 15px;
            padding: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #ffffff;
            font-size: 1.05rem;
            line-height: 1.5;
            text-align: left;
            outline: none !important;
            box-shadow: none !important;
        }

        .option:hover {
            background: rgba(255, 255, 0, 0.15) !important;
            border-color: rgba(255, 255, 0, 0.5) !important;
            transform: translateX(5px);
        }

        .option:focus,
        .option:focus-visible,
        .option:active {
            outline: none !important;
            box-shadow: none !important;
        }

        .option.selected {
            background: rgba(255, 255, 0, 0.2) !important;
            border-color: rgba(255, 255, 0, 0.6) !important;
        }

        /* Results Screen */
        .results-screen {
            display: none;
            text-align: center;
        }

        .results-title {
            color: #ffff00;
            font-size: 2.2rem;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        .pattern-result {
            background: rgba(255, 255, 0, 0.1);
            border: 2px solid rgba(255, 255, 0, 0.4);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .pattern-title {
            color: #ffff00;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .pattern-description {
            color: #e0e0e0;
            line-height: 1.7;
            font-size: 1.05rem;
            margin-bottom: 1rem;
        }

        .contradiction-highlight {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid rgba(255, 100, 100, 0.4);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .contradiction-title {
            color: #ff6666;
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .contradiction-text {
            color: #e0e0e0;
            line-height: 1.6;
        }

        .cta-section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 0, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .cta-title {
            color: #ffff00;
            font-size: 1.6rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .cta-description {
            color: #e0e0e0;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            font-size: 1.05rem;
        }

        .cta-button {
            background: linear-gradient(45deg, #ffff00, #ffff66);
            color: #000;
            border: none;
            padding: 1.2rem 2.5rem;
            font-size: 1.15rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.3);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.5);
        }

        .secondary-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 0, 0.4);
            color: #ffffff;
            padding: 1rem 2rem;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .secondary-button:hover {
            background: rgba(255, 255, 0, 0.1);
            border-color: rgba(255, 255, 0, 0.6);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .game-card {
                padding: 2rem;
            }

            .logo {
                font-size: 2.5rem;
            }

            .subtitle {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <div class="container">
        <div class="game-card" id="game-card">
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="welcome-screen">
                <div class="stage-indicator">STAGE 2 OF 3</div>
                <div class="logo">THRIVE</div>
                <div class="subtitle">Deep Dive: Your Specific Patterns</div>

                <div class="previous-result" id="previous-result">
                    <!-- Previous game result will be inserted here -->
                </div>

                <div class="description">
                    Now we're going to show you exactly where the gaps are. We'll ask 10 more questions designed to catch the contradictions between what you SAY you value and what you ACTUALLY do in specific situations.
                </div>

                <div class="description">
                    <span class="highlight">This gets uncomfortable. That's the point.</span>
                </div>

                <button class="start-button" onclick="startDeepDive()">I'M READY - SHOW ME THE GAPS</button>
            </div>

            <!-- Question Screen -->
            <div id="question-screen" class="question-screen">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="question-number" id="question-number"></div>
                <div class="question-text" id="question-text"></div>
                <div class="options" id="options"></div>
            </div>

            <!-- Results Screen -->
            <div id="results-screen" class="results-screen">
                <div class="results-title">The Pattern Is Clear</div>

                <div class="pattern-result" id="pattern-result">
                    <!-- Combined analysis will be inserted here -->
                </div>

                <div id="contradictions-section">
                    <!-- Contradictions will be inserted here -->
                </div>

                <div class="cta-section">
                    <div class="cta-title">üéØ Ready for Your Complete Profile?</div>
                    <div class="cta-description">
                        You've now completed 20 questions that revealed your surface patterns and some key contradictions.
                        The full OCEAN assessment (60 questions) will give you a complete personality profile, precise pattern matching,
                        and AI coaching personalized to your specific behavioral patterns.
                    </div>
                    <button class="cta-button" onclick="continueToOcean()">GET MY COMPLETE PROFILE</button>
                    <br>
                    <button class="secondary-button" onclick="viewStage1Results()">Review Stage 1 Results</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import question banks
        import { thriveVitalityQuestions } from './question-banks/thrive-vitality-questions.js';
        import { thriveRelationshipsQuestions } from './question-banks/thrive-relationships-questions.js';
        import { thriveHealthQuestions } from './question-banks/thrive-health-questions.js';
        import { thriveIdentityQuestions } from './question-banks/thrive-identity-questions.js';
        import { thriveTimeQuestions } from './question-banks/thrive-time-questions.js';
        import { thriveEnvironmentQuestions } from './question-banks/thrive-environment-questions.js';

        // Combine all questions
        const allQuestions = [
            ...thriveVitalityQuestions,
            ...thriveRelationshipsQuestions,
            ...thriveHealthQuestions,
            ...thriveIdentityQuestions,
            ...thriveTimeQuestions,
            ...thriveEnvironmentQuestions
        ];

        // Load Stage 1 results
        const stage1Data = JSON.parse(sessionStorage.getItem('viralGameResults') || '{}');

        // Transform questions for Stage 2
        function transformQuestionForStage2(q) {
            const transformedOptions = q.options.map(opt => {
                const isAutomatic = (
                    (opt.ocean?.N > 0.5) ||
                    (opt.ocean?.C < -0.2) ||
                    (opt.ocean?.E < -0.3)
                );

                return {
                    text: opt.text,
                    pattern: isAutomatic ? 'automatic' : 'conscious',
                    domain: q.domain || 'vitality',
                    ocean: opt.ocean,
                    pattern_type: opt.pattern_type
                };
            });

            return {
                id: q.id,
                scenario: q.scenario,
                options: transformedOptions,
                category: q.category || 'general'
            };
        }

        // Select 10 NEW questions (different from Stage 1)
        const stage1Ids = stage1Data.responses?.map(r => r.questionId) || [];
        const stage2Questions = allQuestions
            .filter(q => !stage1Ids.includes(q.id))
            .map(transformQuestionForStage2)
            .sort(() => Math.random() - 0.5)
            .slice(0, 10);

        // Game state
        let currentQuestion = 0;
        let responses = [];

        // Initialize particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Display Stage 1 summary
        function displayStage1Summary() {
            if (!stage1Data.analysis) {
                document.getElementById('previous-result').innerHTML = `
                    <div class="previous-result-title">‚ö†Ô∏è No Stage 1 Data Found</div>
                    <div class="previous-result-text">
                        It looks like you haven't completed Stage 1 yet. <a href="/viral-game.html" style="color: #ffff00;">Start from the beginning</a>
                    </div>
                `;
                return;
            }

            document.getElementById('previous-result').innerHTML = `
                <div class="previous-result-title">Your Stage 1 Result:</div>
                <div class="previous-result-text">
                    ${stage1Data.analysis.patternTitle.replace(/[üéØ‚öñÔ∏èüåü]/g, '').trim()}<br>
                    <strong>${stage1Data.analysis.automaticPercentage.toFixed(0)}% automatic</strong> |
                    <strong>${stage1Data.analysis.consciousPercentage.toFixed(0)}% conscious</strong>
                </div>
            `;
        }

        // Start Stage 2
        window.startDeepDive = function() {
            // Blur the button that was clicked to prevent focus issues
            if (document.activeElement) {
                document.activeElement.blur();
            }

            hideScreen('welcome-screen');
            setTimeout(() => {
                showScreen('question-screen');
                showQuestion();
            }, 150);
        };

        // Show question
        function showQuestion() {
            if (currentQuestion >= stage2Questions.length) {
                showResults();
                return;
            }

            // Blur any focused element to prevent auto-focus on last option
            if (document.activeElement) {
                document.activeElement.blur();
            }

            const question = stage2Questions[currentQuestion];
            const progress = ((currentQuestion + 1) / stage2Questions.length) * 100;

            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('question-number').textContent = `Question ${currentQuestion + 1} of ${stage2Questions.length}`;
            document.getElementById('question-text').textContent = question.scenario;

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option.text;
                optionElement.tabIndex = -1; // Make non-focusable via keyboard
                optionElement.onclick = () => selectOption(index, option, question);
                optionsContainer.appendChild(optionElement);
            });

            // Ensure no options are selected when question first loads
            setTimeout(() => {
                document.querySelectorAll('.option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.blur(); // Explicitly blur each option
                });
            }, 10);
        }

        // Handle option selection
        window.selectOption = function(optionIndex, option, question) {
            document.querySelectorAll('.option').forEach((opt, idx) => {
                if (idx === optionIndex) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });

            responses.push({
                questionIndex: currentQuestion,
                questionId: question.id,
                optionIndex: optionIndex,
                option: option,
                timestamp: Date.now()
            });

            currentQuestion++;
            setTimeout(() => {
                const card = document.getElementById('game-card');
                card.classList.add('fade-out');
                setTimeout(() => {
                    showQuestion();
                    card.classList.remove('fade-out');
                }, 150);
            }, 900);
        };

        // Analyze combined results
        function analyzeCombinedResults() {
            // Stage 2 analysis
            const automaticCount = responses.filter(r => r.option.pattern === 'automatic').length;
            const consciousCount = responses.filter(r => r.option.pattern === 'conscious').length;
            const stage2AutoPercent = (automaticCount / responses.length) * 100;

            // Combined analysis (Stage 1 + Stage 2)
            const totalAutomatic = (stage1Data.analysis?.automaticPercentage || 0) * 10 + stage2AutoPercent * 10;
            const combinedAutoPercent = totalAutomatic / 20;

            // Detect contradictions (changed pattern between stages)
            const stage1AutoPercent = stage1Data.analysis?.automaticPercentage || 50;
            const patternShift = Math.abs(stage2AutoPercent - stage1AutoPercent);
            const hasContradiction = patternShift > 20;

            let title, description, contradictionText = '';

            if (hasContradiction) {
                if (stage2AutoPercent > stage1AutoPercent) {
                    // Became MORE automatic in Stage 2
                    contradictionText = `üîç <strong>Pattern Shift Detected:</strong> When we asked deeper questions, your automatic responses increased from ${stage1AutoPercent.toFixed(0)}% to ${stage2AutoPercent.toFixed(0)}%. This suggests you\'re more conscious in general situations but fall back to automatic patterns when specifics get challenging.`;
                } else {
                    // Became LESS automatic (MORE conscious) in Stage 2
                    const stage1Conscious = 100 - stage1AutoPercent;
                    const stage2Conscious = 100 - stage2AutoPercent;
                    contradictionText = `üîç <strong>Interesting Pattern:</strong> Your conscious responses increased from ${stage1Conscious.toFixed(0)}% to ${stage2Conscious.toFixed(0)}%. The deeper questions revealed MORE consciousness, suggesting you have strong self-awareness that shows up more when facing specific situations.`;
                }
            }

            title = `üìä Combined Profile: ${combinedAutoPercent.toFixed(0)}% Automatic`;
            description = `Across both stages (20 questions total), your pattern is becoming clear. You\'re ${combinedAutoPercent >= 60 ? 'predominantly operating from automatic scripts' : combinedAutoPercent >= 40 ? 'split between automatic and conscious patterns' : 'unusually conscious in your choices'}. ${contradictionText}`;

            return {
                title,
                description,
                combinedAutoPercent,
                hasContradiction,
                contradictionText,
                stage2AutoPercent
            };
        }

        // Show results
        function showResults() {
            const analysis = analyzeCombinedResults();

            // Store Stage 2 results
            sessionStorage.setItem('viralGameStage2Results', JSON.stringify({
                responses,
                analysis,
                timestamp: Date.now()
            }));

            document.getElementById('pattern-result').innerHTML = `
                <div class="pattern-title">${analysis.title}</div>
                <div class="pattern-description">${analysis.description}</div>
            `;

            if (analysis.hasContradiction) {
                document.getElementById('contradictions-section').innerHTML = `
                    <div class="contradiction-highlight">
                        <div class="contradiction-title">‚ö†Ô∏è Contradiction Detected</div>
                        <div class="contradiction-text">${analysis.contradictionText}</div>
                    </div>
                `;
            }

            hideScreen('question-screen');
            setTimeout(() => showScreen('results-screen'), 150);
        }

        // Navigation
        window.continueToOcean = function() {
            window.location.href = '/ocean-assessment.html';
        };

        window.viewStage1Results = function() {
            window.location.href = '/viral-game.html';
        };

        // Screen management
        function hideScreen(screenId) {
            document.getElementById(screenId).style.display = 'none';
        }

        function showScreen(screenId) {
            document.getElementById(screenId).style.display = 'block';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            displayStage1Summary();
        });
    </script>
</body>
</html>
